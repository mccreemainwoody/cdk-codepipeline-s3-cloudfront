
# CodePipeline S3 CodeFront CDK Project

A fancy little project I've made to get more familiar with the AWS CDK. You
can use it to export your favorite static website project from a GitHub repo
and export it to an S3 bucket with a CloudFront distribution. Pretty cool,
right? :D  This project is written in Python 3.12 and use Poetry as a package
manager, keep that in mind when you're trying to run it.


## Prerequisites

You will need to have the following installed on your machine:

- [Python 3.12](https://www.python.org/downloads/)
- [Poetry](https://python-poetry.org/docs/)

- [Node.js](https://nodejs.org/en/download/) (this is how you install the AWS CDK)
- [AWS CDK](https://docs.aws.amazon.com/cdk/latest/guide/work-with-cdk-python.html)

- [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)
- [Git](https://git-scm.com/downloads) (to clone the project)


## Getting Started

To get started, clone the repository to your local machine.

Once you're done cloning the project, setup the Poetry environment. You can do
that by running the following command:
```
$ poetry install
```

If you don't use Poetry and prefer to use a good old PIP environment, you can
download the dependencies using the requirement.txt file instead :
```
$ pip install -r requirements.txt
```


This CDK stack fetches the source code from a GitHub repository, so you're 
gonna have to provide some variables to make it work.

Create a `.env` file at the root of the project...
```bash
$ touch .env
```

... and add the following variables to it (of course, you will have to replace
the values with the parameters that suits your needs) :
```dotenv
GITHUB_OWNER=your-github-username
GITHUB_REPO=your-github-repo
GITHUB_BRANCH=your-github-branch
```


AWS CDK also requires a OAuth2 token to access the GitHub API. In order to 
create and reference this token, follow the following steps :
1) Go to your GitHub account settings > Developer settings > Personal access tokens
2) Choose any token type (fine-grained token or classic token) and choose
   "Create a new token". You need to give the token the following permissions :
    - If you're using a classic token :
        - repo
        - admin:repo_hook
    
    - If you're using a fine-grained token :
        - Repository permissions > Contents > Read
        - Repository permissions > Pull requests > Read
        - Repository permissions > Webhooks > Read & write
3) Go to your AWS Secrets Manager interface (API or console) and create a new 
   secret with the following key-value pairs (replace the your-github-token 
   with your actual token):
    - github-token : your-github-token

If for any reason you don't want to set github-token as a secret key, you may 
also change the value the CDK will use by setting the following environment
variable in the `.env` file (replace your-secret-key with the key name you've 
set in Secrets Manager) :
```dotenv
SECRETS_MANAGER_GITHUB_TOKEN_KEY=your-secret-key
```


Once you've setup your environment, that's it ! You can start putting some CDK
magic withing your project and see the environment come to life !


## Usage

To have a view of the CloudFormation template generated by the CDK, you can
run the following command :
```bash
$ cdk synth
```

**Note :** The CDK only writes the template on the console, so if you want to
keep a version in a YAML file, you will have to add some thingies after the 
main command. I recommand creating an output folder where you can store the
command template outputs, like so :
```bash
$ mkdir output
$ cdk synth > output/template.yaml
```

AWS CDK is also compatible with unit testing. In fact, you can even see how 
well it manages testing procedures with this project, with tests cases already
written ! You can use pytest to run the tests, like so :
```bash
$ pytest
```

Before deploying the stack, CDK needs to bootstrap a few stuff on your AWS
region environment. The following command will do the trick :
```bash
$ cdk bootstrap
```

Make sure you have given CDK the right permissions before running the 
command ! You need to give write permissions to the CDK to these services :
- CloudFormation
- S3 (at least to create a bucket)
- IAM (so that it can create roles)
- SSM (that's how CDK handles stack versions)


To deploy the stack to your AWS account, you can run the following command :
```bash
$ cdk deploy
```

If you're making some changes and and don't really want to run `cdk deploy`
every 10 minutes, you can run the watch command to automatically deploy the 
stack  every time you save a file :
```bash
$ cdk watch
```

If you want to destroy the stack, you can run the following command :
```bash
$ cdk destroy
```

If you don't really want to change anything but want to check differences
between the current stack and what's deployed on your AWS environment, you can 
run this to only see the differences :
```bash
$ cdk diff
```

Enjoy!
